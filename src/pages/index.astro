---
import BaseLayout from "@/layouts/base-layout.astro";
import Projects from "@/components/projects.astro";
import { getCollection, type CollectionEntry } from "astro:content";

import Posts from "@/components/posts.astro";
import PinnedPosts from "@/components/pinned-posts.astro";
import SeriesList from "@/components/series.astro";
import Intro from "@/components/intro.astro";

const posts = (await getCollection("blog"))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .filter((post) => !post.data.planned && post.data.published);

const sortedPostsByYear = new Map<number, CollectionEntry<"blog">[]>();

posts.slice(0, 3).forEach((post) => {
  const year = post.data.pubDate.getFullYear();
  if (sortedPostsByYear.has(year)) {
    sortedPostsByYear.get(year)?.push(post);
  } else {
    sortedPostsByYear.set(year, [post]);
  }
});

const pinnedPosts = posts.filter(
  (post) => post.data.pinned && post.data.published
);

const pinnedSeries = (await getCollection("series")).filter(
  (s) => s.data.pinned && s.data.published
);

const projects = await getCollection("project");
const sortedProjects = projects.sort((a, b) => a.data.index - b.data.index);
---

<BaseLayout>
  <div class="container mx-auto max-w-3xl space-y-10 px-4">
    <Intro />

    <Projects projects={sortedProjects} />

    {pinnedPosts.length > 0 && <PinnedPosts posts={pinnedPosts} />}

    {
      pinnedSeries.length > 0 && (
        <div class="space-y-8">
          <div class="flex items-end justify-between">
            <h2 class="text-2xl font-bold">Pinned Series</h2>
            <a
              href="/series"
              class="text-sm font-medium underline-offset-2 hover:underline"
            >
              View all
            </a>
          </div>
          <SeriesList seriesList={pinnedSeries} />
        </div>
      )
    }

    <div class="space-y-8">
      <div class="flex items-end justify-between">
        <h2 class="text-2xl font-bold">Latest Posts</h2>
        {
          posts.length > 0 && (
            <a
              href="/blog"
              class="text-sm font-medium underline-offset-2 hover:underline"
            >
              View all
            </a>
          )
        }
      </div>
      {
        posts.length > 0 ? (
          <Posts posts={sortedPostsByYear} />
        ) : (
          <p class="font-semibold">
            There is no posts here yet but I'm
            currently working ğŸ‘·â€â™‚ï¸ on a tutorial series called "Lambda Calculus
            For All". Stay Tuned ğŸ˜„!
          </p>
        )
      }
    </div>
  </div>
</BaseLayout>
